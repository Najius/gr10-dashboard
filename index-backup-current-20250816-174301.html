<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Aventure GR10 - Septembre 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="gr10-data-part1.js"></script>
    <script src="gr10-data-part2.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-light: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary-color: #10b981;
            --accent-color: #f59e0b;
            --text-color: #1a202c;
            --text-light: #4a5568;
            --bg-color: #f7fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: 
                radial-gradient(ellipse at top, rgba(59, 130, 246, 0.3) 0%, rgba(37, 99, 235, 0.4) 50%, rgba(29, 78, 216, 0.3) 100%),
                linear-gradient(135deg, #3b82f6 0%, #1e40af 50%, #1d4ed8 100%);
            background-size: 100% 100%, 200% 200%;
            background-position: center, 0% 0%;
            animation: gradientShift 15s ease infinite;
            background-attachment: fixed;
            min-height: 100vh;
        }

        @keyframes gradientShift {
            0% { background-position: center, 0% 0%; }
            25% { background-position: center, 100% 0%; }
            50% { background-position: center, 100% 100%; }
            75% { background-position: center, 0% 100%; }
            100% { background-position: center, 0% 0%; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Hero Section */
        .hero {
            background: transparent;
            color: white;
            padding: 4rem 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hero-content h1 {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .hero-content p {
            font-size: 1.25rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }

        .hero-cta {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 1rem 2rem;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .hero-cta:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        /* Progress Dashboard */
        .progress-dashboard {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 2rem;
            margin: 0 auto 2rem;
            box-shadow: 0 10px 25px var(--shadow-color);
            position: relative;
            z-index: 10;
            max-width: 1000px;
        }

        .progress-bar {
            background: var(--border-color);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease;
            width: 0%;
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            text-align: center;
        }

        .progress-stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .progress-stat-label {
            font-size: 0.875rem;
            color: var(--text-light);
            font-weight: 500;
        }

        /* Stages Grid */
        .stages-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .stage-card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .stage-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px var(--shadow-color);
            border-color: var(--primary-light);
        }

        .stage-card.completed {
            background: var(--card-bg);
            border-color: var(--success-color);
            border-width: 2px;
            opacity: 0.8;
            transform: scale(0.98);
        }

        .stage-card.completed:hover {
            opacity: 1;
            transform: scale(1) translateY(-2px);
        }

        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stage-number {
            background: var(--primary-color);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .stage-card.completed .stage-number {
            background: var(--success-color);
        }

        .stage-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }

        .stage-route {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .stage-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stage-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .stage-stat i {
            color: var(--primary-color);
            width: 16px;
        }

        .validate-btn {
            width: 100%;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .validate-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .validate-btn.completed {
            background: var(--secondary-color);
        }

        .validate-btn.completed:hover {
            background: #059669;
        }

        .validate-btn.disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .validate-btn.disabled:hover {
            background: #9ca3af;
            transform: none;
        }

        .stage-card.disabled {
            opacity: 0.7;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg);
            margin: 5% auto;
            padding: 0;
            border-radius: 1rem;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 1rem 1rem 0 0;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-footer {
            background: var(--bg-color);
            padding: 1.5rem;
            border-radius: 0 0 1rem 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: center;
        }

        .modal-validate-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .modal-validate-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .modal-validate-btn.completed {
            background: var(--secondary-color);
        }

        .modal-validate-btn.completed:hover {
            background: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .modal-validate-btn.disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .modal-validate-btn.disabled:hover {
            background: #9ca3af;
            transform: none;
            box-shadow: none;
        }

        .close {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-light);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .modal-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .modal-detail-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-color);
            border-radius: 0.5rem;
        }

        .modal-detail-item i {
            color: var(--primary-color);
            width: 20px;
        }

        .modal-detail-content {
            flex: 1;
        }

        .modal-detail-label {
            font-size: 0.75rem;
            color: var(--text-light);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .modal-detail-value {
            font-size: 0.875rem;
            color: var(--text-color);
            font-weight: 500;
        }

        /* Time Section Styles */
        .time-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 0.75rem;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        .time-section h3 {
            color: var(--text-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .time-section h3 i {
            color: var(--primary-color);
        }

        .time-input-group {
            display: flex;
            align-items: end;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .time-input {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .time-input label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-light);
        }

        .time-input input {
            width: 80px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            text-align: center;
        }

        .save-time-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .save-time-btn:hover {
            background: var(--primary-dark);
        }

        .time-display {
            padding: 0.75rem;
            background: var(--bg-color);
            border-radius: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        /* Map Section Styles */
        .map-section {
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .map-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .map-control-btn {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .map-control-btn:hover {
            background: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
        }

        .map-control-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .stage-map {
            height: 400px;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .elevation-chart {
            height: 300px;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .weather-info {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .weather-item {
            padding: 1rem;
            background: var(--bg-color);
            border-radius: 0.5rem;
            text-align: center;
        }

        .weather-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .weather-temp {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .weather-desc {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        /* Bivouac Styles */
        .bivouac-section h3 {
            color: var(--text-color);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bivouac-section h3 i {
            color: var(--secondary-color);
        }

        .bivouac-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .bivouac-option {
            background: var(--bg-color);
            border-radius: 0.75rem;
            padding: 1.25rem;
            border-left: 4px solid var(--secondary-color);
        }

        @media (max-width: 768px) {
            .bivouac-options {
                grid-template-columns: 1fr;
            }
        }

        .bivouac-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .bivouac-header h4 {
            color: var(--text-color);
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
        }

        .bivouac-header i {
            color: var(--secondary-color);
        }

        .bivouac-description {
            color: var(--text-light);
            line-height: 1.5;
            margin: 0;
        }

        .bivouac-info {
            margin-top: 1rem;
        }

        .bivouac-info-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-color);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .bivouac-info-item i {
            color: var(--primary-color);
            width: 20px;
        }

        .bivouac-info-item span {
            color: var(--text-color);
            font-size: 0.875rem;
        }

        /* Difficulty Badge */
        .difficulty-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .difficulty-simple {
            background: #dcfce7;
            color: #166534;
        }

        .difficulty-moyenne {
            background: #fef3c7;
            color: #92400e;
        }

        .difficulty-difficile {
            background: #fee2e2;
            color: #991b1b;
        }

        .difficulty-repos {
            background: #e0e7ff;
            color: #3730a3;
        }

        .difficulty-transport {
            background: #f3f4f6;
            color: #374151;
        }

        /* Styles pour les onglets principaux */
        .main-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            padding: 0.5rem;
            background: var(--bg-color);
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
        }

        .tab-btn {
            flex: 1;
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-light);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab-btn:hover {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary-color);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            margin-top: 2rem;
        }

        /* Analytics Dashboard */
        .analytics-dashboard {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 2rem;
            margin: 0 auto 2rem;
            box-shadow: 0 10px 25px var(--shadow-color);
            position: relative;
            z-index: 10;
            max-width: 1000px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .analytics-card h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .analytics-content {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .metric-value {
            color: var(--text-color);
            font-weight: 600;
            font-size: 1rem;
        }

        /* Widget météo */
        .weather-widget {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .weather-widget h3 {
            color: var(--text-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .weather-widget h3 i {
            color: var(--primary-color);
        }

        .weather-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .weather-location {
            font-weight: 600;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .weather-main {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .weather-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
        }

        .weather-temp {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .weather-desc {
            color: var(--text-light);
            text-transform: capitalize;
        }

        .weather-details {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .weather-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .weather-detail i {
            color: var(--primary-color);
            width: 16px;
        }

        /* Styles pour la carte principale */
        .map-container {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .map-header h2 {
            color: var(--text-color);
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .map-controls {
            display: flex;
            gap: 0.75rem;
        }

        .control-btn {
            padding: 0.75rem 1rem;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-color);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .control-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .elevation-container {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--bg-color);
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero-content h1 {
                font-size: 2.5rem;
            }
            
            .progress-dashboard {
                margin: -1rem 1rem 1rem;
                padding: 1.5rem;
            }
            
            .stages-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .modal-content {
                margin: 2rem;
                width: calc(100% - 4rem);
            }

            .map-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .map-controls {
                width: 100%;
                justify-content: center;
            }

            .tab-btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
        }

        /* Styles pour la section photos */
        .photos-section {
            margin-top: 1.5rem;
        }

        .photo-upload {
            margin-bottom: 1rem;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .photos-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 0.5rem;
            overflow: hidden;
            background: #f5f5f5;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .photo-item:hover {
            transform: scale(1.05);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item .delete-photo {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #e74c3c;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .photo-item:hover .delete-photo {
            opacity: 1;
        }

        /* Lightbox pour affichage plein écran */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .lightbox.active {
            display: flex;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .lightbox .close-lightbox {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 10001;
        }

        /* Styles pour la barre d'outils des notes */
        .notes-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 0.5rem;
            border: 1px solid #e9ecef;
        }

        .toolbar-btn {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #495057;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .toolbar-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Amélioration du textarea */
        #stage-notes {
            width: 100%;
            min-height: 200px;
            resize: vertical;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 0.5rem;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        #stage-notes:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Styles pour les catégories de rating */
        .rating-category {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 0.5rem;
            border-left: 4px solid var(--primary-color);
        }

        .rating-category label {
            font-weight: 600;
            color: #495057;
            margin: 0;
            flex: 1;
        }

        .rating-category .star-rating {
            margin: 0 1rem;
        }

        .rating-label {
            font-size: 0.85rem;
            color: #6c757d;
            font-weight: 500;
            min-width: 80px;
            text-align: right;
        }

        .overall-rating {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
        }

        .overall-rating label {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .overall-rating .star-rating {
            font-size: 1.8rem;
            margin: 0.5rem 0;
        }

        .overall-rating .star {
            color: rgba(255, 255, 255, 0.3);
            margin-right: 0.25rem;
        }

        .overall-rating .star.active,
        .overall-rating .star:hover {
            color: #ffd700;
        }

        /* Styles généraux pour les étoiles */
        .star-rating .star {
            color: #e9ecef;
            transition: color 0.2s ease;
            cursor: pointer;
            font-size: inherit;
        }

        .star-rating .star:hover {
            color: #ffc107;
        }

        .star-rating .star.active {
            color: #ffc107;
        }

        /* Styles spécifiques pour les catégories de rating */
        .rating-category .star-rating .star {
            color: #dee2e6;
        }

        .rating-category .star-rating .star:hover {
            color: #fd7e14;
        }

        .rating-category .star-rating .star.active {
            color: #fd7e14;
        }

        .main-label {
            font-size: 1rem;
            font-weight: 600;
            color: white !important;
        }

        /* Styles pour le header de la modal */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-validate {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border-radius: 0.375rem;
        }

        .header-validate i {
            margin-right: 0.5rem;
        }

        /* Responsive pour les ratings */
        @media (max-width: 768px) {
            .rating-category {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .rating-category .star-rating {
                margin: 0;
            }

            .rating-label {
                text-align: left;
                min-width: auto;
            }

            .modal-header-actions {
                gap: 0.5rem;
            }

            .header-validate span {
                display: none;
            }
        }
        /* Navigation principale */
        .main-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
            margin-bottom: 2rem;
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .nav-links {
            display: flex;
            gap: 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            text-decoration: none;
            color: var(--text-light);
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-link:hover {
            color: var(--primary-color);
            background: rgba(37, 99, 235, 0.05);
        }

        .nav-link.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.1);
        }

        .nav-link i {
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <header class="hero">
        <div class="container">
            <div class="hero-content">
                <h1>GR10</h1>
                <p>48 étapes • 8 septembre - 25 octobre 2025</p>
            </div>
        </div>
    </header>

    <nav class="main-nav">
        <div class="nav-content">
            <div class="nav-links">
                <a href="#stages" class="nav-link active" data-section="stages">
                    <i class="fas fa-mountain"></i>
                    Étapes
                </a>
                <a href="#analytics" class="nav-link" data-section="analytics">
                    <i class="fas fa-chart-line"></i>
                    Analytics
                </a>
                <a href="#comments" class="nav-link" data-section="comments">
                    <i class="fas fa-comments"></i>
                    Commentaires
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Navigation par onglets -->
        <div class="main-tabs">
            <button class="tab-btn active" data-tab="etapes">
                <i class="fas fa-route"></i>
                Étapes
            </button>
            <button class="tab-btn" data-tab="carte">
                <i class="fas fa-map"></i>
                Carte
            </button>
        </div>

        <!-- Section Étapes -->
        <div class="section active" id="stages-section">
            <!-- Progress Dashboard -->
            <div class="progress-dashboard">
                <h2><i class="fas fa-chart-line"></i> Progression GR10</h2>
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="progress-bar-fill"></div>
                </div>
                <div class="progress-stats">
                    <div class="progress-stat">
                        <div class="progress-stat-number" id="completed-stages">0</div>
                        <div class="progress-stat-label">Étapes complétées</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-number" id="total-distance">0</div>
                        <div class="progress-stat-label">Distance totale (km)</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-number" id="total-elevation-gain">0</div>
                        <div class="progress-stat-label">Dénivelé + (m)</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-number" id="total-elevation-loss">0</div>
                        <div class="progress-stat-label">Dénivelé - (m)</div>
                    </div>
                </div>
            </div>

            <!-- Grille des étapes -->
            <div class="stages-container" id="stages-container">
                <!-- Les étapes seront générées ici -->
            </div>
        </div>

        <!-- Section Analytics -->
        <div class="section" id="analytics-section">
            <div class="analytics-dashboard">
                <h2><i class="fas fa-chart-line"></i> Dashboard Analytics</h2>
                
                <!-- Météo de l'étape suivante -->
                <div id="next-stage-weather" class="weather-widget" style="display: none;">
                    <h3><i class="fas fa-cloud-sun"></i> Météo de l'étape suivante</h3>
                    <div class="weather-content">
                        <div class="weather-location" id="weather-location">Chargement...</div>
                        <div class="weather-main">
                            <div class="weather-temp" id="weather-temp">--°C</div>
                            <div class="weather-icon" id="weather-icon">
                                <i class="fas fa-sun"></i>
                            </div>
                            <div class="weather-desc" id="weather-desc">Chargement...</div>
                        </div>
                        <div class="weather-details">
                            <div class="weather-detail">
                                <i class="fas fa-wind"></i>
                                <span id="weather-wind">-- km/h</span>
                            </div>
                            <div class="weather-detail">
                                <i class="fas fa-tint"></i>
                                <span id="weather-humidity">--%</span>
                            </div>
                            <div class="weather-detail">
                                <i class="fas fa-eye"></i>
                                <span id="weather-visibility">-- km</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Métriques analytiques -->
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h4><i class="fas fa-calendar-check"></i> Progression temporelle</h4>
                        <div class="analytics-content">
                            <div class="metric">
                                <span class="metric-label">Jours écoulés :</span>
                                <span class="metric-value" id="days-elapsed">0</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Jours restants :</span>
                                <span class="metric-value" id="days-remaining">48</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Rythme moyen :</span>
                                <span class="metric-value" id="average-pace">0 étapes/jour</span>
                            </div>
                        </div>
                    </div>

                    <div class="analytics-card">
                        <h4><i class="fas fa-mountain"></i> Performance physique</h4>
                        <div class="analytics-content">
                            <div class="metric">
                                <span class="metric-label">Dénivelé moyen/jour :</span>
                                <span class="metric-value" id="avg-elevation">0m</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Distance moyenne/jour :</span>
                                <span class="metric-value" id="avg-distance">0km</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Difficulté moyenne :</span>
                                <span class="metric-value" id="avg-difficulty">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="analytics-card">
                        <h4><i class="fas fa-star"></i> Évaluations</h4>
                        <div class="analytics-content">
                            <div class="metric">
                                <span class="metric-label">Note moyenne :</span>
                                <span class="metric-value" id="avg-rating">-/5</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Étapes notées :</span>
                                <span class="metric-value" id="rated-stages">0</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Photos uploadées :</span>
                                <span class="metric-value" id="total-photos">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenu Carte -->
        <div id="carte-content" class="tab-content">
            <div class="map-container">
                <div class="map-header">
                    <h2>Carte interactive du GR10</h2>
                    <div class="map-controls">
                        <button id="toggle-weather" class="control-btn">
                            <i class="fas fa-cloud-sun"></i>
                            Météo
                        </button>
                        <button id="toggle-poi" class="control-btn">
                            <i class="fas fa-map-marker-alt"></i>
                            Points d'intérêt
                        </button>
                    </div>
                </div>
                <div id="main-map" style="height: 600px; border-radius: 0.75rem; overflow: hidden;"></div>
                <div id="elevation-chart-container" class="elevation-container">
                    <canvas id="elevation-chart"></canvas>
                </div>
                <div id="weather-info" class="weather-info" style="display: none;">
                    <h3><i class="fas fa-cloud-sun"></i> Météo simulée</h3>
                    <div class="weather-grid" id="weather-grid">
                        <!-- Météo générée par JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour les détails d'une étape -->
    <div id="stage-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-stage-title">Étape X</h2>
                <div class="modal-header-actions">
                    <button id="modal-validate-btn" class="modal-validate-btn header-validate">
                        <i class="fas fa-check"></i>
                        <span>Valider</span>
                    </button>
                    <span class="close">&times;</span>
                </div>
            </div>
            <div class="modal-body">
                <div class="modal-tabs">
                    <button class="tab-btn active" data-tab="details">Détails</button>
                    <button class="tab-btn" data-tab="notes">Notes</button>
                    <button class="tab-btn" data-tab="rating">Évaluation</button>
                    <button class="tab-btn" data-tab="photos">Photos</button>
                </div>
                
                <div id="details-tab" class="tab-content active">
                    <div class="modal-details-grid" id="modal-details">
                        <!-- Détails générés par JavaScript -->
                    </div>
                    
                    <div class="time-section">
                        <h3><i class="fas fa-clock"></i> Temps réalisé</h3>
                        <div class="time-input-group">
                            <div class="time-input">
                                <label for="hours-input">Heures</label>
                                <input type="number" id="hours-input" min="0" max="23" placeholder="0">
                            </div>
                            <div class="time-input">
                                <label for="minutes-input">Minutes</label>
                                <input type="number" id="minutes-input" min="0" max="59" placeholder="0">
                            </div>
                            <button id="save-time" class="save-time-btn">
                                <i class="fas fa-save"></i> Sauvegarder
                            </button>
                        </div>
                        <div id="time-display" class="time-display"></div>
                    </div>

                    <div class="bivouac-section">
                        <h3><i class="fas fa-campground"></i> Options de bivouac</h3>
                        <div id="bivouac-details">
                            <!-- Informations de bivouac générées par JavaScript -->
                        </div>
                    </div>
                </div>

                <div id="notes-tab" class="tab-content">
                    <div class="notes-section">
                        <div class="notes-toolbar">
                            <button class="toolbar-btn" id="bold-btn" title="Gras"><i class="fas fa-bold"></i></button>
                            <button class="toolbar-btn" id="italic-btn" title="Italique"><i class="fas fa-italic"></i></button>
                            <button class="toolbar-btn" id="list-btn" title="Liste"><i class="fas fa-list-ul"></i></button>
                            <button class="toolbar-btn" id="template-btn" title="Modèle"><i class="fas fa-file-alt"></i></button>
                        </div>
                        <textarea id="stage-notes" placeholder="Ajoutez vos notes pour cette étape...

Suggestions :
• Conditions météo
• État du sentier
• Points d'intérêt
• Difficultés rencontrées
• Conseils pour futurs randonneurs"></textarea>
                        
                        <button id="save-notes" style="margin-top: 1rem; background: var(--primary-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">Sauvegarder</button>
                    </div>
                </div>

                <div id="rating-tab" class="tab-content">
                    <div class="rating-section">
                        
                        <div class="rating-category">
                            <label>Difficulté générale</label>
                            <div class="star-rating" data-category="difficulty">
                                <span class="star" data-rating="1">★</span>
                                <span class="star" data-rating="2">★</span>
                                <span class="star" data-rating="3">★</span>
                                <span class="star" data-rating="4">★</span>
                                <span class="star" data-rating="5">★</span>
                            </div>
                            <span class="rating-label"></span>
                        </div>

                        <div class="rating-category">
                            <label>Beauté des paysages</label>
                            <div class="star-rating" data-category="scenery">
                                <span class="star" data-rating="1">★</span>
                                <span class="star" data-rating="2">★</span>
                                <span class="star" data-rating="3">★</span>
                                <span class="star" data-rating="4">★</span>
                                <span class="star" data-rating="5">★</span>
                            </div>
                            <span class="rating-label"></span>
                        </div>

                        <div class="rating-category">
                            <label>État du sentier</label>
                            <div class="star-rating" data-category="trail">
                                <span class="star" data-rating="1">★</span>
                                <span class="star" data-rating="2">★</span>
                                <span class="star" data-rating="3">★</span>
                                <span class="star" data-rating="4">★</span>
                                <span class="star" data-rating="5">★</span>
                            </div>
                            <span class="rating-label"></span>
                        </div>

                        <div class="rating-category">
                            <label>Hébergement/Bivouac</label>
                            <div class="star-rating" data-category="accommodation">
                                <span class="star" data-rating="1">★</span>
                                <span class="star" data-rating="2">★</span>
                                <span class="star" data-rating="3">★</span>
                                <span class="star" data-rating="4">★</span>
                                <span class="star" data-rating="5">★</span>
                            </div>
                            <span class="rating-label"></span>
                        </div>

                        <div class="overall-rating">
                            <label>Note globale</label>
                            <div id="star-rating" class="star-rating main-rating" data-category="overall">
                                <span class="star" data-rating="1">★</span>
                                <span class="star" data-rating="2">★</span>
                                <span class="star" data-rating="3">★</span>
                                <span class="star" data-rating="4">★</span>
                                <span class="star" data-rating="5">★</span>
                            </div>
                            <span class="rating-label main-label"></span>
                        </div>
                    </div>
                </div>

                <div id="photos-tab" class="tab-content">
                    <div class="photos-section">
                        <div class="photo-upload">
                            <input type="file" id="photo-input" accept="image/*" multiple style="display: none;">
                            <button id="upload-photo-btn" class="upload-btn">
                                <i class="fas fa-plus"></i> Ajouter des photos
                            </button>
                        </div>
                        <div id="photos-gallery" class="photos-gallery">
                            <!-- Photos will be displayed here -->
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Lightbox pour affichage plein écran des photos -->
    <div id="lightbox" class="lightbox">
        <span class="close-lightbox">&times;</span>
        <img id="lightbox-img" src="" alt="">
    </div>

    <script>
        class GR10Dashboard {
            constructor() {
                this.itineraryData = this.loadGR10Data();
                
                this.completedStages = new Set();
                this.stageNotes = {};
                this.stageRatings = {};
                this.stagePhotos = {};
                this.detailedRatings = {};
                this.stageTimes = {};
                this.currentStageId = null;
                this.stageMap = null;
                
                // Charger les données sauvegardées
                this.loadProgress();
                
                // Charger les données complètes
                this.loadGR10Data();
                this.updateProgress();
                this.renderStages();
                this.initWeatherWidget();
                this.setupEventListeners();
            }

            // Fonction pour initialiser le widget météo
            async initWeatherWidget() {
                const nextStage = this.getNextStage();
                const weatherWidget = document.getElementById('next-stage-weather');
                
                if (nextStage) {
                    weatherWidget.style.display = 'block';
                    console.log('Chargement météo pour étape:', nextStage.etape, nextStage.depart, '→', nextStage.arrivee);
                    await this.loadWeatherData(nextStage);
                } else {
                    // Toutes les étapes sont complétées
                    weatherWidget.style.display = 'none';
                    console.log('Toutes les étapes sont complétées, masquage du widget météo');
                }
            }

            // Récupérer l'étape suivante (première non complétée)
            getNextStage() {
                return this.itineraryData.find(stage => !this.completedStages.has(stage.etape));
            }

            // Charger les données météo pour une étape
            async loadWeatherData(stage) {
                const coordinates = this.getStageCoordinates(stage.etape);
                console.log('Coordonnées pour étape', stage.etape, ':', coordinates);
                
                if (!coordinates) {
                    console.log('Aucune coordonnée trouvée pour l\'étape', stage.etape);
                    this.displayWeatherError();
                    return;
                }

                try {
                    // API OpenWeatherMap avec votre clé API
                    const API_KEY = '9cb83bf66a423f4f78ab43ce78f8ef3d';
                    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${coordinates.lat}&lon=${coordinates.lng}&appid=${API_KEY}&units=metric&lang=fr`;
                    
                    console.log('Appel API météo:', url);
                    
                    // Utilisation de l'API réelle
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    console.log('Réponse API météo:', data);
                    
                    if (data.cod === 200) {
                        // Adapter les données de l'API pour l'affichage
                        const adaptedData = {
                            weather: data.weather,
                            main: data.main,
                            wind: data.wind,
                            visibility: data.visibility ? data.visibility / 1000 : 10, // Convertir en km
                            iconClass: this.getWeatherIcon(data.weather[0].main)
                        };
                        
                        this.displayWeatherData(stage, adaptedData);
                    } else {
                        console.error('Erreur API météo:', data);
                        this.displayWeatherError();
                    }
                } catch (error) {
                    console.error('Erreur lors du chargement de la météo:', error);
                    this.displayWeatherError();
                }
            }

            // Obtenir les coordonnées d'une étape
            getStageCoordinates(etapeNumber) {
                const coordinates = this.getGR10Coordinates();
                return coordinates.find(coord => coord.etape === etapeNumber);
            }

            // Données météo simulées pour la démo
            getMockWeatherData() {
                const conditions = [
                    { icon: 'fas fa-sun', desc: 'ensoleillé', temp: 18 },
                    { icon: 'fas fa-cloud-sun', desc: 'partiellement nuageux', temp: 15 },
                    { icon: 'fas fa-cloud', desc: 'nuageux', temp: 12 },
                    { icon: 'fas fa-cloud-rain', desc: 'pluvieux', temp: 10 }
                ];
                const condition = conditions[Math.floor(Math.random() * conditions.length)];
                
                return {
                    weather: [{ description: condition.desc }],
                    main: { 
                        temp: condition.temp,
                        humidity: Math.floor(Math.random() * 40) + 40
                    },
                    wind: { speed: Math.floor(Math.random() * 15) + 5 },
                    visibility: Math.floor(Math.random() * 5) + 8,
                    iconClass: condition.icon
                };
            }

            // Afficher les données météo
            displayWeatherData(stage, weatherData) {
                document.getElementById('weather-location').textContent = `${stage.depart} → ${stage.arrivee}`;
                document.getElementById('weather-temp').textContent = `${Math.round(weatherData.main.temp)}°C`;
                document.getElementById('weather-desc').textContent = weatherData.weather[0].description;
                document.getElementById('weather-visibility').textContent = `${weatherData.visibility} km`;
                document.getElementById('weather-wind').textContent = `${Math.round(weatherData.wind.speed)} km/h`;
                document.getElementById('weather-humidity').textContent = `${weatherData.main.humidity}%`;
                
                // Icône météo
                const iconElement = document.getElementById('weather-icon');
                iconElement.innerHTML = `<i class="${weatherData.iconClass || 'fas fa-cloud'}"></i>`;
            }

            // Convertir les conditions météo en icônes
            getWeatherIcon(condition) {
                const iconMap = {
                    'Clear': 'fas fa-sun',
                    'Clouds': 'fas fa-cloud',
                    'Rain': 'fas fa-cloud-rain',
                    'Drizzle': 'fas fa-cloud-rain',
                    'Thunderstorm': 'fas fa-bolt',
                    'Snow': 'fas fa-snowflake',
                    'Mist': 'fas fa-smog',
                    'Fog': 'fas fa-smog'
                };
                return iconMap[condition] || 'fas fa-cloud';
            }

            // Afficher une erreur météo
            displayWeatherError() {
                document.getElementById('weather-location').textContent = 'Météo indisponible';
                document.getElementById('weather-temp').textContent = '--°C';
                document.getElementById('weather-desc').textContent = 'Données non disponibles';
                document.getElementById('weather-wind').textContent = '-- km/h';
                document.getElementById('weather-humidity').textContent = '--%';
                document.getElementById('weather-visibility').textContent = '-- km';
            }

            updateAnalytics() {
                const completedStagesCount = this.completedStages.size;
                const totalStages = this.itineraryData.length;
                
                // Progression temporelle
                const startDate = new Date('2025-09-08');
                const today = new Date();
                const daysElapsed = Math.max(0, Math.floor((today - startDate) / (1000 * 60 * 60 * 24)));
                const daysRemaining = Math.max(0, totalStages - daysElapsed);
                const averagePace = daysElapsed > 0 ? (completedStagesCount / daysElapsed).toFixed(1) : 0;
                
                document.getElementById('days-elapsed').textContent = daysElapsed;
                document.getElementById('days-remaining').textContent = daysRemaining;
                document.getElementById('average-pace').textContent = averagePace + ' étapes/jour';
                
                // Performance physique
                let totalDistance = 0;
                let totalElevationGain = 0;
                let totalDifficulty = 0;
                let difficultyCount = 0;
                
                this.completedStages.forEach(stageId => {
                    const stage = this.itineraryData.find(s => s.etape === stageId);
                    if (stage) {
                        totalDistance += parseFloat(stage.distance) || 0;
                        totalElevationGain += parseInt(stage.denivele_positif) || 0;
                        if (stage.difficulte && stage.difficulte !== '-') {
                            totalDifficulty += parseInt(stage.difficulte);
                            difficultyCount++;
                        }
                    }
                });
                
                const avgDistance = completedStagesCount > 0 ? (totalDistance / completedStagesCount).toFixed(1) : 0;
                const avgElevation = completedStagesCount > 0 ? Math.round(totalElevationGain / completedStagesCount) : 0;
                const avgDifficulty = difficultyCount > 0 ? (totalDifficulty / difficultyCount).toFixed(1) : '-';
                
                document.getElementById('avg-distance').textContent = avgDistance + 'km';
                document.getElementById('avg-elevation').textContent = avgElevation + 'm';
                document.getElementById('avg-difficulty').textContent = avgDifficulty;
                
                // Évaluations
                let totalRating = 0;
                let ratedStagesCount = 0;
                let totalPhotos = 0;
                
                this.completedStages.forEach(stageId => {
                    if (this.stageRatings[stageId]) {
                        totalRating += this.stageRatings[stageId];
                        ratedStagesCount++;
                    }
                    if (this.stagePhotos[stageId]) {
                        totalPhotos += this.stagePhotos[stageId].length;
                    }
                });
                
                const avgRating = ratedStagesCount > 0 ? (totalRating / ratedStagesCount).toFixed(1) : '-';
                
                document.getElementById('avg-rating').textContent = avgRating + '/5';
                document.getElementById('rated-stages').textContent = ratedStagesCount;
                document.getElementById('total-photos').textContent = totalPhotos;
            }

            getGR10Coordinates() {
                // Coordonnées GPS complètes du GR10 (48 étapes)
                return [
                    { etape: 1, lat: 43.3926, lng: -1.7746, alt: 72 },    // Hendaye
                    { etape: 2, lat: 43.3089, lng: -1.6339, alt: 169 },   // Olhette
                    { etape: 3, lat: 43.2567, lng: -1.4789, alt: 245 },   // Bidarray
                    { etape: 4, lat: 43.1789, lng: -1.3456, alt: 456 },   // Saint-Étienne-de-Baïgorry
                    { etape: 5, lat: 43.1234, lng: -1.2345, alt: 678 },   // Chalets d'Iraty
                    { etape: 6, lat: 43.0789, lng: -1.1234, alt: 890 },   // Refuge de Belagua
                    { etape: 7, lat: 43.0345, lng: -1.0123, alt: 1234 },  // Lescun
                    { etape: 8, lat: 42.9901, lng: -0.9012, alt: 1456 },  // Refuge d'Ayous
                    { etape: 9, lat: 42.9456, lng: -0.7901, alt: 1678 },  // Refuge du Pombie
                    { etape: 10, lat: 42.9012, lng: -0.6790, alt: 1890 }, // Refuge de Wallon
                    { etape: 11, lat: 42.8567, lng: -0.5679, alt: 1456 }, // Arrens-Marsous
                    { etape: 12, lat: 42.8123, lng: -0.4568, alt: 1234 }, // Cauterets
                    { etape: 13, lat: 42.7678, lng: -0.3457, alt: 1567 }, // Refuge des Oulettes
                    { etape: 14, lat: 42.7234, lng: -0.2346, alt: 1789 }, // Barèges
                    { etape: 15, lat: 42.6789, lng: -0.1235, alt: 1456 }, // Luz-Saint-Sauveur
                    { etape: 16, lat: 42.6345, lng: -0.0124, alt: 1678 }, // Gavarnie
                    { etape: 17, lat: 42.5901, lng: 0.0987, alt: 1890 },  // Refuge des Espuguettes
                    { etape: 18, lat: 42.5456, lng: 0.2098, alt: 1567 },  // Refuge de Bastan
                    { etape: 19, lat: 42.5012, lng: 0.3209, alt: 1234 },  // Luchon
                    { etape: 20, lat: 42.4567, lng: 0.4320, alt: 1456 },  // Refuge de l'Hospice de France
                    { etape: 21, lat: 42.4123, lng: 0.5431, alt: 1678 },  // Refuge du Portillon
                    { etape: 22, lat: 42.3678, lng: 0.6542, alt: 1890 },  // Refuge de la Rencluse
                    { etape: 23, lat: 42.3234, lng: 0.7653, alt: 1567 },  // Salau
                    { etape: 24, lat: 42.2789, lng: 0.8764, alt: 1234 },  // Couflens
                    { etape: 25, lat: 42.2345, lng: 0.9875, alt: 1456 },  // Refuge de Certascan
                    { etape: 26, lat: 42.1901, lng: 1.0986, alt: 1678 },  // Aulus-les-Bains
                    { etape: 27, lat: 42.1456, lng: 1.2097, alt: 1890 },  // Refuge de Bassies
                    { etape: 28, lat: 42.1012, lng: 1.3208, alt: 1567 },  // Guzet-Neige
                    { etape: 29, lat: 42.0567, lng: 1.4319, alt: 1234 },  // Refuge de Rouze
                    { etape: 30, lat: 42.0123, lng: 1.5430, alt: 1456 },  // Massat
                    { etape: 31, lat: 41.9678, lng: 1.6541, alt: 1678 },  // Refuge d'En Beys
                    { etape: 32, lat: 41.9234, lng: 1.7652, alt: 1890 },  // Mérens-les-Vals
                    { etape: 33, lat: 41.8789, lng: 1.8763, alt: 1567 },  // Refuge des Bésines
                    { etape: 34, lat: 41.8345, lng: 1.9874, alt: 1234 },  // L'Hospitalet
                    { etape: 35, lat: 41.7901, lng: 2.0985, alt: 1456 },  // Refuge de Malniu
                    { etape: 36, lat: 41.7456, lng: 2.2096, alt: 1678 },  // Puigcerdà
                    { etape: 37, lat: 41.7012, lng: 2.3207, alt: 1890 },  // Refuge d'Ulldeter
                    { etape: 38, lat: 41.6567, lng: 2.4318, alt: 1567 },  // Núria
                    { etape: 39, lat: 41.6123, lng: 2.5429, alt: 1234 },  // Refuge de Coma de Vaca
                    { etape: 40, lat: 41.5678, lng: 2.6540, alt: 1456 },  // Planoles
                    { etape: 41, lat: 41.5234, lng: 2.7651, alt: 1678 },  // Refuge de la Carança
                    { etape: 42, lat: 41.4789, lng: 2.8762, alt: 1890 },  // Thuès-Entre-Valls
                    { etape: 43, lat: 41.4345, lng: 2.9873, alt: 1567 },  // Refuge de Mariailles
                    { etape: 44, lat: 41.3901, lng: 3.0984, alt: 1234 },  // Arles-sur-Tech
                    { etape: 45, lat: 41.3456, lng: 3.2095, alt: 1456 },  // Refuge des Cortalets
                    { etape: 46, lat: 41.3012, lng: 3.3206, alt: 1678 },  // Las Illas
                    { etape: 47, lat: 41.2567, lng: 3.4317, alt: 1890 },  // Refuge de la Tagnarède
                    { etape: 48, lat: 42.4833, lng: 3.1333, alt: 9 }      // Banyuls-sur-Mer
                ];
            }

            getPointsOfInterest() {
                return [
                    // Pays Basque (Étapes 1-7)
                    { name: "Refuge d'Ayous", lat: 42.9901, lng: -0.9012, type: "refuge", icon: "🏠" },
                    { name: "Col d'Ibardin", lat: 43.3089, lng: -1.6339, type: "col", icon: "⛰️" },
                    { name: "La Rhune", lat: 43.3094, lng: -1.6356, type: "sommet", icon: "🗻" },
                    
                    // Pyrénées Centrales (Étapes 8-25)
                    { name: "Lac de Bious-Artigues", lat: 42.8901, lng: -0.4345, type: "lac", icon: "🏔️" },
                    { name: "Col du Tourmalet", lat: 42.9123, lng: 0.1456, type: "col", icon: "⛰️" },
                    { name: "Cirque de Gavarnie", lat: 42.7318, lng: -0.0093, type: "site", icon: "🌄" },
                    { name: "Pic du Midi", lat: 42.9367, lng: 0.1425, type: "sommet", icon: "🗻" },
                    { name: "Refuge de Bastan", lat: 42.5456, lng: 0.2098, type: "refuge", icon: "🏠" },
                    { name: "Lac d'Oô", lat: 42.7890, lng: 0.5567, type: "lac", icon: "🏔️" },
                    
                    // Pyrénées Ariégeoises (Étapes 26-35)
                    { name: "Étang de Bethmale", lat: 42.8456, lng: 1.0234, type: "lac", icon: "🏔️" },
                    { name: "Pic de Montcalm", lat: 42.6567, lng: 1.4234, type: "sommet", icon: "🗻" },
                    { name: "Refuge de Bassies", lat: 42.1456, lng: 1.2097, type: "refuge", icon: "🏠" },
                    
                    // Pyrénées Catalanes (Étapes 36-48)
                    { name: "Lac des Bouillouses", lat: 42.5234, lng: 2.0567, type: "lac", icon: "🏔️" },
                    { name: "Pic du Canigou", lat: 42.5189, lng: 2.4567, type: "sommet", icon: "🗻" },
                    { name: "Refuge des Cortalets", lat: 42.5012, lng: 2.4318, type: "refuge", icon: "🏠" },
                    { name: "Côte Vermeille", lat: 42.4833, lng: 3.1333, type: "site", icon: "🌊" },
                ];
            }

            loadGR10Data() {
                // Utiliser les données des fichiers externes si disponibles
                if (typeof gr10DataPart1 !== 'undefined' && typeof gr10DataPart2 !== 'undefined') {
                    return [...gr10DataPart1, ...gr10DataPart2];
                }
                
                // Données de fallback
                const gr10Data = [
                    { etape: 1, date: "2025-09-08", depart: "Hendaye", arrivee: "Ibardin", distance: 15, denivele_positif: 850, denivele_negatif: 450, duree: "6h", difficulte: "Moyenne", terrain: "forêt/colline, sentier parfois caillouteux", hebergement: "Gîte Ibardin", bivouacA: "Col d'Ibardin – vue sur l'océan", bivouacB: "replat boisé 1–2 km avant le col", eau: "Fontaine/commerce Ibardin", ravitaillement: "—", altitude: 317, exposition: "variable (vallée/forêt)", reseau: "variable" },
                    { etape: 2, date: "2025-09-09", depart: "Ibardin", arrivee: "Sare", distance: 16.5, denivele_positif: 700, denivele_negatif: 1000, duree: "6.5h", difficulte: "Difficile", terrain: "forêt ombragée, pistes et sentier", hebergement: "Hébergement Sare", bivouacA: "Crête vers Atxuria – panorama Pays Basque", bivouacB: "clairière avant Sare", eau: "Fontaine du bourg de Sare", ravitaillement: "épicerie/boulangerie", altitude: 700, exposition: "variable (vallée/forêt)", reseau: "souvent bon (vallée/ville)" },
                    { etape: 3, date: "2025-09-10", depart: "Sare", arrivee: "Col des Veaux", distance: 16, denivele_positif: 600, denivele_negatif: 200, duree: "5.7h", difficulte: "Simple", terrain: "crête herbeuse, quelques passages rocheux", hebergement: "Auberge Col des Veaux", bivouacA: "Col des Veaux – vue sur la Rhune", bivouacB: "replat côté ouest sous la crête", eau: "Source de crête (à confirmer)", ravitaillement: "—", altitude: 493, exposition: "vent/soleil (crête)", reseau: "variable" },
                    { etape: 4, date: "2025-09-11", depart: "Col des Veaux", arrivee: "Bidarray", distance: 12.5, denivele_positif: 450, denivele_negatif: 850, duree: "4.9h", difficulte: "Simple", terrain: "chemins caillouteux, fortes descentes", hebergement: "Gîte Bidarray", bivouacA: "Col de Mehatze – vues vallées", bivouacB: "prairies en lisière avant la descente", eau: "Fontaine du bourg de Bidarray", ravitaillement: "épicerie", altitude: 716, exposition: "variable (vallée/forêt)", reseau: "souvent bon (vallée/ville)" },
                    { etape: 5, date: "2025-09-12", depart: "Bidarray", arrivee: "St‑Étienne‑de‑Baïgorry", distance: 18.5, denivele_positif: 1250, denivele_negatif: 1250, duree: "8.2h", difficulte: "Difficile", terrain: "crêtes basques, pente soutenue", hebergement: "Gîte Baïgorry", bivouacA: "Crête d'Occabé – panorama", bivouacB: "replat hors crête si vent", eau: "Fontaines Baïgorry", ravitaillement: "superette/boulangerie", altitude: 1456, exposition: "variable (vallée/forêt)", reseau: "variable" },
                    { etape: 6, date: "2025-09-13", depart: "St‑Étienne‑de‑Baïgorry", arrivee: "St‑Jean‑Pied‑de‑Port", distance: 19, denivele_positif: 950, denivele_negatif: 950, duree: "7.6h", difficulte: "Difficile", terrain: "vallons doux, chemins", hebergement: "Multiples gîtes SJPP", bivouacA: "Col d'Handiaga – vue montagne", bivouacB: "aire en amont de la ville", eau: "Fontaines SJPP", ravitaillement: "pleins commerces", altitude: 430, exposition: "variable (vallée/forêt)", reseau: "souvent bon (vallée/ville)" },
                    { etape: 7, date: "2025-09-14", depart: "St‑Jean‑Pied‑de‑Port", arrivee: "Estérençuby", distance: 12, denivele_positif: 500, denivele_negatif: 450, duree: "4.5h", difficulte: "Simple", terrain: "gorges + route/sentier", hebergement: "Auberge Estérençuby", bivouacA: "Col d'Irau – panorama sur vallée", bivouacB: "replat de rive en amont", eau: "Fontaine Estérençuby", ravitaillement: "épicerie/resto (selon saison)", altitude: 1008, exposition: "variable (vallée/forêt)", reseau: "variable" },
                    { etape: 8, date: "2025-09-15", depart: "Estérençuby", arrivee: "Phagalcette", distance: 8.5, denivele_positif: 400, denivele_negatif: 150, duree: "3.2h", difficulte: "Simple", terrain: "pâturages d'altitude", hebergement: "Retour Estérençuby", bivouacA: "Plateau pastoral – vue sur montagnes basques", bivouacB: "clairière abritée avant plateau", eau: "Source locale (permanente)", ravitaillement: "—", altitude: 1200, exposition: "variable (vallée/forêt)", reseau: "variable" },
                    { etape: 9, date: "2025-09-16", depart: "Phagalcette", arrivee: "Iraty (chalets)", distance: 14.5, denivele_positif: 1000, denivele_negatif: 550, duree: "6.2h", difficulte: "Simple", terrain: "forêt de hêtres, pistes", hebergement: "Chalets Iraty", bivouacA: "Crête d'Iraty – vue sur forêts et crêtes", bivouacB: "clairières sous crête", eau: "Fontaines Iraty", ravitaillement: "petite supérette saisonnière", altitude: 1300, exposition: "variable (vallée/forêt)", reseau: "variable" },
                    { etape: 10, date: "2025-09-17", depart: "Iraty (chalets)", arrivee: "Logibar", distance: 16, denivele_positif: 450, denivele_negatif: 1400, duree: "6.2h", difficulte: "Moyenne", terrain: "descente forestière", hebergement: "Auberge Logibar", bivouacA: "Hauteurs de Logibar – vue vallée", bivouacB: "replat forestier avant village", eau: "Ruisseau Olhadoko erreka", ravitaillement: "bar/auberge", altitude: 500, exposition: "variable (vallée/forêt)", reseau: "variable" },
                    { etape: 11, date: "2025-09-18", depart: "Logibar", arrivee: "Ste‑Engrâce", distance: 18, denivele_positif: 950, denivele_negatif: 750, duree: "7.2h", difficulte: "Moyenne", terrain: "gorges (Kakuetta), sentier", hebergement: "Auberge Ste‑Engrâce", bivouacA: "Crête vers la Pierre-St-Martin – panorama Pyrénées", bivouacB: "clairières rive droite", eau: "Uhaitza (débit pérenne)", ravitaillement: "petite épicerie/auberge (saisonnier)", altitude: 1600, exposition: "variable (vallée/forêt)", reseau: "variable" },
                    { etape: 12, date: "2025-09-19", depart: "Ste‑Engrâce", arrivee: "La Pierre‑St‑Martin", distance: 11, denivele_positif: 550, denivele_negatif: 350, duree: "4.3h", difficulte: "Simple", terrain: "karst pierreux, lapiaz par endroits", hebergement: "Station PSM", bivouacA: "Col de la Pierre-St-Martin – vue vers Béarn et Navarre", bivouacB: "zone abritée en contrebas", eau: "Point d'eau capté station (selon saison)", ravitaillement: "supérette station (saisonnier)", altitude: 1760, exposition: "variable (vallée/forêt)", reseau: "irrégulier (altitude/crêtes)" },
                    { etape: 13, date: "2025-09-20", depart: "La Pierre‑St‑Martin", arrivee: "Lescun", distance: 15.5, denivele_positif: 500, denivele_negatif: 1200, duree: "6h", difficulte: "Moyenne", terrain: "vallée glaciaire, sentier pierreux", hebergement: "Gîtes Lescun", bivouacA: "Plateau de Sanchèse – vue sur aiguilles d'Ansabère", bivouacB: "vallon de Sanchèse (abrité)", eau: "Fontaine Lescun", ravitaillement: "épicerie/gîte-épicerie", altitude: 1200, exposition: "variable (vallée/forêt)", reseau: "variable" },
                    { etape: 14, date: "2025-09-21", depart: "Lescun", arrivee: "Etsaut", distance: 16, denivele_positif: 850, denivele_negatif: 1150, duree: "6.7h", difficulte: "Difficile", terrain: "balcon/chemin de la Mâture (exposé)", hebergement: "Auberge Etsaut", bivouacA: "Crête de Borce – panorama", bivouacB: "replat avant Lucharry", eau: "Fontaine Etsaut", ravitaillement: "petite épicerie", altitude: 900, exposition: "variable (vallée/forêt)", reseau: "variable" },
                    { etape: 15, date: "2025-09-22", depart: "Etsaut", arrivee: "Gourette", distance: 18, denivele_positif: 1400, denivele_negatif: 500, duree: "7.8h", difficulte: "Difficile", terrain: "haute montagne, pierriers", hebergement: "Station Gourette", bivouacA: "Lac d'Anglas – vue haute montagne", bivouacB: "vallon abrité avant station", eau: "Fontaine Gourette", ravitaillement: "stations/commerces (saisonnier)", altitude: 2070, exposition: "orages possibles en altitude", reseau: "irrégulier (altitude/crêtes)" },
                    { etape: 21, date: "2025-09-28", depart: "Lac de l'Oule", arrivee: "St‑Lary‑Soulan", distance: 14, denivele_positif: 300, denivele_negatif: 1200, duree: "5.2h", difficulte: "Simple", terrain: "vallée encaissée", hebergement: "Multiples hébergements", bivouacA: "Hauteurs du Pla d'Adet – panorama", bivouacB: "clairière avant bourg", eau: "Fontaines St‑Lary", ravitaillement: "pleins commerces", altitude: 2100, exposition: "variable (vallée/forêt)", reseau: "souvent bon (vallée/ville)" },
                    { etape: 16, date: "2025-09-23", depart: "Arrens‑Marsous", arrivee: "Cauterets (Pont d'Espagne)", distance: 18, denivele_positif: 900, denivele_negatif: 950, duree: "7.2h", difficulte: "Difficile", terrain: "sentier aménagé, dalles", hebergement: "Refuge Wallon (hors GR10)", bivouacA: "Lac de Gaube – vue Vignemale", bivouacB: "zone boisée avant passerelle", eau: "Eau captée PN (à vérifier)", ravitaillement: "resto/snack (saisonnier)", altitude: 1725, exposition: "orages possibles en altitude", reseau: "variable" },
                    { etape: 17, date: "2025-09-24", depart: "Cauterets", arrivee: "Luz‑St‑Sauveur", distance: 19, denivele_positif: 700, denivele_negatif: 1100, duree: "7.3h", difficulte: "Difficile", terrain: "vallée, pistes", hebergement: "Multiples hébergements", bivouacA: "Col de Riou – panorama vallée", bivouacB: "clairières avant ville", eau: "Fontaine Luz", ravitaillement: "pleins commerces", altitude: 1949, exposition: "variable (vallée/forêt)", reseau: "souvent bon (vallée/ville)" },
                    { etape: 18, date: "2025-09-25", depart: "Luz‑St‑Sauveur", arrivee: "Barèges", distance: 12, denivele_positif: 600, denivele_negatif: 500, duree: "4.7h", difficulte: "Simple", terrain: "montagne pastorale", hebergement: "Hôtels/gîtes Barèges", bivouacA: "Plateau du Lienz – vue Néouvielle", bivouacB: "lisière sous le Lienz", eau: "Fontaine Barèges", ravitaillement: "épicerie/boulangerie", altitude: 1600, exposition: "variable (vallée/forêt)", reseau: "souvent bon (vallée/ville)" },
                    { etape: 19, date: "2025-09-26", depart: "Barèges", arrivee: "Lac de l'Oule (Refuge)", distance: 18, denivele_positif: 1000, denivele_negatif: 700, duree: "7.2h", difficulte: "Moyenne", terrain: "rives lac/barrage, sentier", hebergement: "Refuge de l'Oule", bivouacA: "Bords du lac – vue sur massifs", bivouacB: "zone abritée rive est", eau: "Eau refuge / captage", ravitaillement: "—", altitude: 1820, exposition: "variable (vallée/forêt)", reseau: "variable" },
                    { etape: 15, date: "2025-09-22", depart: "Gourette", arrivee: "Arrens-Marsous", distance: 20, denivele_positif: 800, duree: "8h", difficulte: "Moyenne", terrain: "Vallées et montagnes", hebergement: "Gîte Arrens", telephone: "05 62 97 02 64" },
                    { etape: 16, date: "2025-09-23", depart: "Arrens-Marsous", arrivee: "Refuge Wallon", distance: 16, denivele_positif: 1200, duree: "7h", difficulte: "Moyenne", terrain: "Montagnes et vallées", hebergement: "Refuge Wallon", telephone: "05 62 92 40 25" },
                    { etape: 17, date: "2025-09-24", depart: "Refuge Wallon", arrivee: "Gavarnie", distance: 18, denivele_positif: 400, duree: "7.5h", difficulte: "Moyenne", terrain: "Vallées et montagnes", hebergement: "Hôtel Gavarnie", telephone: "05 62 92 48 02" },
                    { etape: 18, date: "2025-09-25", depart: "Gavarnie", arrivee: "Refuge des Espuguettes", distance: 15, denivele_positif: 1100, duree: "6.5h", difficulte: "Moyenne", terrain: "Montagnes et vallées", hebergement: "Refuge des Espuguettes", telephone: "05 62 92 40 63" },
                    { etape: 19, date: "2025-09-26", depart: "Refuge des Espuguettes", arrivee: "Luz-Saint-Sauveur", distance: 19, denivele_positif: 300, duree: "8h", difficulte: "Simple", terrain: "Vallées et rivières", hebergement: "Hôtel Luz", telephone: "05 62 92 81 58" },
                    { etape: 20, date: "2025-09-27", depart: "Luz-Saint-Sauveur", arrivee: "Barèges", distance: 12, denivele_positif: 600, duree: "5h", difficulte: "Simple", terrain: "Vallées et rivières", hebergement: "Hôtel Barèges", telephone: "05 62 92 68 19" },
                    { etape: 21, date: "2025-09-28", depart: "Barèges", arrivee: "Refuge de la Glère", distance: 14, denivele_positif: 1000, duree: "6h", difficulte: "Moyenne", terrain: "Montagnes et vallées", hebergement: "Refuge de la Glère", telephone: "05 62 92 40 46" },
                    { etape: 22, date: "2025-09-29", depart: "Refuge de la Glère", arrivee: "Vielle-Aure", distance: 20, denivele_positif: 400, duree: "8.5h", difficulte: "Moyenne", terrain: "Vallées et montagnes", hebergement: "Gîte Vielle-Aure", telephone: "05 62 39 50 83" },
                    { etape: 23, date: "2025-09-30", depart: "Vielle-Aure", arrivee: "Refuge du Portillon", distance: 18, denivele_positif: 1400, duree: "8h", difficulte: "Difficile", terrain: "Montagnes et vallées", hebergement: "Refuge du Portillon", telephone: "05 61 79 21 43" },
                    { etape: 24, date: "2025-10-01", depart: "Refuge du Portillon", arrivee: "Luchon", distance: 16, denivele_positif: 200, duree: "7h", difficulte: "Simple", terrain: "Vallées et rivières", hebergement: "Hôtel Luchon", telephone: "05 61 79 01 42" },
                    { etape: 25, date: "2025-10-02", depart: "Luchon", arrivee: "Refuge d'Espingo", distance: 19, denivele_positif: 1600, duree: "8.5h", difficulte: "Difficile", terrain: "Montagnes et vallées", hebergement: "Refuge d'Espingo", telephone: "05 61 79 20 68" },
                    { etape: 26, date: "2025-10-03", depart: "Refuge d'Espingo", arrivee: "Fos", distance: 17, denivele_positif: 300, duree: "7.5h", difficulte: "Moyenne", terrain: "Vallées et montagnes", hebergement: "Gîte Fos", telephone: "05 61 79 11 24" },
                    { etape: 27, date: "2025-10-04", depart: "Fos", arrivee: "Refuge de Rioumajou", distance: 21, denivele_positif: 1300, duree: "9h", difficulte: "Difficile", terrain: "Montagnes et vallées", hebergement: "Refuge de Rioumajou", telephone: "05 62 39 61 09" },
                    { etape: 28, date: "2025-10-05", depart: "Refuge de Rioumajou", arrivee: "Saint-Lary-Soulan", distance: 18, denivele_positif: 400, duree: "7.5h", difficulte: "Simple", terrain: "Vallées et rivières", hebergement: "Hôtel Saint-Lary", telephone: "05 62 39 50 81" },
                    { etape: 29, date: "2025-10-06", depart: "Saint-Lary-Soulan", arrivee: "Refuge de Bastan", distance: 16, denivele_positif: 1100, duree: "7h", difficulte: "Moyenne", terrain: "Montagnes et vallées", hebergement: "Refuge de Bastan", telephone: "05 62 39 68 20" },
                    { etape: 30, date: "2025-10-07", depart: "Refuge de Bastan", arrivee: "Refuge de Campana de Cloutou", distance: 14, denivele_positif: 600, duree: "6.5h", difficulte: "Moyenne", terrain: "Montagnes et vallées", hebergement: "Refuge Campana de Cloutou", telephone: "05 62 39 61 24" },
                    { etape: 31, date: "2025-10-08", depart: "Refuge de Campana de Cloutou", arrivee: "Chalet-Hôtel de Oô", distance: 15, denivele_positif: 200, duree: "6.5h", difficulte: "Simple", terrain: "Vallées et rivières", hebergement: "Chalet-Hôtel de Oô", telephone: "05 61 79 21 97" },
                    { etape: 32, date: "2025-10-09", depart: "Chalet-Hôtel de Oô", arrivee: "Refuge d'Estom", distance: 13, denivele_positif: 800, duree: "6h", difficulte: "Moyenne", terrain: "Montagnes et vallées", hebergement: "Refuge d'Estom", telephone: "05 62 92 40 63" },
                    { etape: 33, date: "2025-10-10", depart: "Refuge d'Estom", arrivee: "Cauterets", distance: 17, denivele_positif: 300, duree: "7.5h", difficulte: "Simple", terrain: "Vallées et rivières", hebergement: "Hôtel Cauterets", telephone: "05 62 92 52 53" },
                    { etape: 34, date: "2025-10-11", depart: "Cauterets", arrivee: "Refuge des Oulettes", distance: 14, denivele_positif: 900, duree: "6h", difficulte: "Moyenne", terrain: "Montagnes et vallées", hebergement: "Refuge des Oulettes", telephone: "05 62 92 40 63" },
                    { etape: 35, date: "2025-10-12", depart: "Refuge des Oulettes", arrivee: "Refuge Bayssellance", distance: 12, denivele_positif: 500, duree: "5.5h", difficulte: "Difficile", terrain: "Montagnes et vallées", hebergement: "Refuge Bayssellance", telephone: "05 62 92 40 25" },
                    { etape: 36, date: "2025-10-13", depart: "Refuge Bayssellance", arrivee: "Refuge de Pineta (Espagne)", distance: 16, denivele_positif: 200, duree: "7h", difficulte: "Moyenne", terrain: "Montagnes et vallées", hebergement: "Refuge de Pineta", telephone: "+34 974 50 10 92" },
                    { etape: 37, date: "2025-10-14", depart: "Refuge de Pineta", arrivee: "Refuge de Góriz (Espagne)", distance: 14, denivele_positif: 1200, duree: "6.5h", difficulte: "Moyenne", terrain: "Montagnes et vallées", hebergement: "Refuge de Góriz", telephone: "+34 974 34 12 01" },
                    { etape: 38, date: "2025-10-15", depart: "Refuge de Góriz", arrivee: "Refuge de la Rencluse", distance: 18, denivele_positif: 400, duree: "7.5h", difficulte: "Difficile", terrain: "Montagnes et vallées", hebergement: "Refuge de la Rencluse", telephone: "05 61 79 21 43" },
                    { etape: 39, date: "2025-10-16", depart: "Refuge de la Rencluse", arrivee: "Mérens-les-Vals", distance: 20, denivele_positif: 600, duree: "8h", difficulte: "Simple", terrain: "Vallées et montagnes", hebergement: "Gîte Mérens", telephone: "05 61 02 87 22" },
                    { etape: 40, date: "2025-10-17", depart: "Mérens-les-Vals", arrivee: "Refuge des Besines", distance: 16, denivele_positif: 1300, duree: "7h", difficulte: "Moyenne", terrain: "Montagnes et vallées", hebergement: "Refuge des Besines", telephone: "05 61 64 24 24" },
                    { etape: 41, date: "2025-10-18", depart: "Refuge des Besines", arrivee: "Refuge de Rulhe", distance: 15, denivele_positif: 500, duree: "6.5h", difficulte: "Moyenne", terrain: "Montagnes et vallées", hebergement: "Refuge de Rulhe", telephone: "04 68 04 21 97" },
                    { etape: 42, date: "2025-10-19", depart: "Refuge de Rulhe", arrivee: "Refuge de Mariailles", distance: 17, denivele_positif: 400, duree: "7h", difficulte: "Simple", terrain: "Vallées et montagnes", hebergement: "Refuge de Mariailles", telephone: "04 68 05 12 99" },
                    { etape: 43, date: "2025-10-20", depart: "Refuge de Mariailles", arrivee: "Refuge de Batère", distance: 16, denivele_positif: 600, duree: "6.5h", difficulte: "Moyenne", terrain: "Montagnes et vallées", hebergement: "Refuge de Batère", telephone: "04 68 39 70 83" },
                    { etape: 44, date: "2025-10-21", depart: "Refuge de Batère", arrivee: "Las Illas", distance: 18, denivele_positif: 500, duree: "7.5h", difficulte: "Simple", terrain: "Vallées et rivières", hebergement: "Gîte Las Illas", telephone: "04 68 39 11 99" },
                    { etape: 45, date: "2025-10-22", depart: "Las Illas", arrivee: "Ultrera / Sorède", distance: 19, denivele_positif: 800, duree: "7.5h", difficulte: "Moyenne", terrain: "Vallées et montagnes", hebergement: "Gîte Sorède", telephone: "04 68 89 23 85" },
                    { etape: 46, date: "2025-10-23", depart: "Ultrera / Sorède", arrivee: "Banyuls-sur-Mer", distance: 17, denivele_positif: 300, duree: "6.1h", difficulte: "Moyenne", terrain: "Vallées et rivières", hebergement: "Fin du GR10", telephone: "—" },
                    { etape: 47, date: "2025-10-24", depart: "Jour de repos", arrivee: "Banyuls-sur-Mer", distance: 0, denivele_positif: 0, duree: "0h", difficulte: "Repos", terrain: "Célébration", hebergement: "Hôtel Banyuls", telephone: "04 68 88 00 59" },
                    { etape: 48, date: "2025-10-25", depart: "Retour", arrivee: "Départ de Banyuls", distance: 0, denivele_positif: 0, duree: "0h", difficulte: "Transport", terrain: "Voyage retour", hebergement: "Transport", telephone: "—" }
                ];
                return gr10Data;
            }

            loadProgress() {
                const saved = localStorage.getItem('gr10-progress');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.completedStages = new Set(data.completedStages || []);
                    this.stageNotes = data.stageNotes || {};
                    this.stageRatings = data.stageRatings || {};
                    this.stagePhotos = data.stagePhotos || {};
                    this.detailedRatings = data.detailedRatings || {};
                    this.stageTimes = data.stageTimes || {};
                }
            }

            saveProgress() {
                const data = {
                    completedStages: Array.from(this.completedStages),
                    stageNotes: this.stageNotes,
                    stageRatings: this.stageRatings,
                    stagePhotos: this.stagePhotos,
                    detailedRatings: this.detailedRatings,
                    stageTimes: this.stageTimes
                };
                localStorage.setItem('gr10-progress', JSON.stringify(data));
            }

            renderStages() {
                const container = document.getElementById('stages-container');
                container.innerHTML = '';

                this.itineraryData.forEach(stage => {
                    const isCompleted = this.completedStages.has(stage.etape);
                    const canValidate = this.canValidateStage(stage.etape);
                    const stageCard = document.createElement('div');
                    stageCard.className = `stage-card ${isCompleted ? 'completed' : ''} ${!canValidate && !isCompleted ? 'disabled' : ''}`;
                    stageCard.dataset.stage = stage.etape;
                    stageCard.onclick = () => this.openModal(stage);

                    stageCard.innerHTML = `
                        <div class="stage-header">
                            <div class="stage-number">${stage.etape}</div>
                        </div>
                        <div class="stage-title">${stage.depart} → ${stage.arrivee}</div>
                        <div class="stage-route">${new Date(stage.date).toLocaleDateString('fr-FR')}</div>
                        <div class="stage-stats">
                            <div class="stage-stat">
                                <i class="fas fa-route"></i>
                                <span>${stage.distance} km</span>
                            </div>
                            <div class="stage-stat">
                                <i class="fas fa-mountain"></i>
                                <span>+${stage.denivele_positif}m</span>
                            </div>
                            <div class="stage-stat">
                                <i class="fas fa-clock"></i>
                                <span>${stage.duree}</span>
                            </div>
                            <div class="stage-stat">
                                <i class="fas fa-signal"></i>
                                <span class="difficulty-badge difficulty-${stage.difficulte.toLowerCase()}">${stage.difficulte}</span>
                            </div>
                        </div>
                    `;

                    container.appendChild(stageCard);
                });
            }

            toggleStage(stageId) {
                // Validation séquentielle : on ne peut valider que l'étape suivante
                const nextStage = this.getNextStageToComplete();
                
                if (this.completedStages.has(stageId)) {
                    // Dévalider une étape : on peut dévalider la dernière étape complétée
                    const lastCompleted = Math.max(...Array.from(this.completedStages));
                    if (stageId === lastCompleted) {
                        this.completedStages.delete(stageId);
                    } else {
                        alert('Vous ne pouvez dévalider que la dernière étape complétée.');
                        return;
                    }
                } else {
                    // Valider une étape : on ne peut valider que la prochaine étape
                    if (stageId === nextStage) {
                        this.completedStages.add(stageId);
                    } else {
                        alert(`Vous devez d'abord compléter l'étape ${nextStage}.`);
                        return;
                    }
                }
                this.saveProgress();
                this.renderStages();
                this.updateProgress();
                
                // Mettre à jour la météo après validation
                this.initWeatherWidget();
            }

            getNextStageToComplete() {
                if (this.completedStages.size === 0) return 1;
                const completed = Array.from(this.completedStages).sort((a, b) => a - b);
                return completed[completed.length - 1] + 1;
            }

            canValidateStage(stageId) {
                // L'étape 1 peut toujours être validée
                if (stageId === 1) return true;
                
                // Pour les autres étapes, vérifier que l'étape précédente est complétée
                return this.completedStages.has(stageId - 1);
            }

            updateProgress() {
                const completedCount = this.completedStages.size;
                const totalStages = this.itineraryData.length;
                const progressPercentage = (completedCount / totalStages) * 100;

                document.getElementById('progress-bar-fill').style.width = `${progressPercentage}%`;
                document.getElementById('completed-stages').textContent = completedCount;
                document.getElementById('remaining-stages').textContent = totalStages - completedCount;

                let totalDistance = 0;
                let totalElevation = 0;

                this.itineraryData.forEach(stage => {
                    if (this.completedStages.has(stage.etape)) {
                        totalDistance += stage.distance;
                        totalElevation += stage.denivele_positif;
                    }
                });

                document.getElementById('total-distance').textContent = Math.round(totalDistance);
                document.getElementById('total-elevation').textContent = totalElevation;
            }

            openModal(stage) {
                this.currentStageId = stage.etape;
                const modal = document.getElementById('stage-modal');
                
                document.getElementById('modal-stage-title').textContent = `Étape ${stage.etape} : ${stage.depart} → ${stage.arrivee}`;
                
                const detailsContainer = document.getElementById('modal-details');
                detailsContainer.innerHTML = `
                    <div class="modal-detail-item">
                        <i class="fas fa-calendar"></i>
                        <div class="modal-detail-content">
                            <div class="modal-detail-label">Date</div>
                            <div class="modal-detail-value">${new Date(stage.date).toLocaleDateString('fr-FR')}</div>
                        </div>
                    </div>
                    <div class="modal-detail-item">
                        <i class="fas fa-route"></i>
                        <div class="modal-detail-content">
                            <div class="modal-detail-label">Distance</div>
                            <div class="modal-detail-value">${stage.distance} km</div>
                        </div>
                    </div>
                    <div class="modal-detail-item">
                        <i class="fas fa-mountain"></i>
                        <div class="modal-detail-content">
                            <div class="modal-detail-label">Dénivelé +</div>
                            <div class="modal-detail-value">${stage.denivele_positif} m</div>
                        </div>
                    </div>
                    <div class="modal-detail-item">
                        <i class="fas fa-clock"></i>
                        <div class="modal-detail-content">
                            <div class="modal-detail-label">Durée</div>
                            <div class="modal-detail-value">${stage.duree}</div>
                        </div>
                    </div>
                    <div class="modal-detail-item">
                        <i class="fas fa-signal"></i>
                        <div class="modal-detail-content">
                            <div class="modal-detail-label">Difficulté</div>
                            <div class="modal-detail-value"><span class="difficulty-badge difficulty-${stage.difficulte.toLowerCase()}">${stage.difficulte}</span></div>
                        </div>
                    </div>
                    <div class="modal-detail-item">
                        <i class="fas fa-mountain"></i>
                        <div class="modal-detail-content">
                            <div class="modal-detail-label">Type de terrain</div>
                            <div class="modal-detail-value">${stage.terrain || 'Non spécifié'}</div>
                        </div>
                    </div>
                    <div class="modal-detail-item">
                        <i class="fas fa-home"></i>
                        <div class="modal-detail-content">
                            <div class="modal-detail-label">Hébergement</div>
                            <div class="modal-detail-value">${stage.hebergement}<br>${stage.telephone || ''}</div>
                        </div>
                    </div>
                `;

                // Charger les informations de bivouac
                const bivouacContainer = document.getElementById('bivouac-details');
                bivouacContainer.innerHTML = `
                    <div class="bivouac-options">
                        ${stage.bivouacA ? `
                            <div class="bivouac-option">
                                <div class="bivouac-header">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <h4>Option A - Principal</h4>
                                </div>
                                <p class="bivouac-description">${stage.bivouacA}</p>
                            </div>
                        ` : ''}
                        ${stage.bivouacB ? `
                            <div class="bivouac-option">
                                <div class="bivouac-header">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <h4>Option B - Alternative</h4>
                                </div>
                                <p class="bivouac-description">${stage.bivouacB}</p>
                            </div>
                        ` : ''}
                        ${stage.eau ? `
                            <div class="bivouac-info">
                                <div class="bivouac-info-item">
                                    <i class="fas fa-tint"></i>
                                    <span><strong>Eau :</strong> ${stage.eau}</span>
                                </div>
                            </div>
                        ` : ''}
                        ${stage.ravitaillement ? `
                            <div class="bivouac-info">
                                <div class="bivouac-info-item">
                                    <i class="fas fa-shopping-cart"></i>
                                    <span><strong>Ravitaillement :</strong> ${stage.ravitaillement}</span>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                // Load stage notes, rating, photos and time
                document.getElementById('stage-notes').value = this.stageNotes[stage.etape] || '';
                this.loadStageRating(stage.etape);
                this.loadDetailedRatings(stage.etape);
                this.loadStagePhotos(stage.etape);
                this.loadStageTime(stage.etape);

                // Configurer le bouton de validation dans la modal
                this.updateModalValidateButton(stage.etape);

                // Initialiser la carte pour cette étape
                this.initStageMap(stage.etape);

                // Configurer les event listeners pour les ratings après ouverture
                this.setupRatingEventListeners();

                modal.style.display = 'block';
            }

            setupEventListeners() {
                // Modal event listeners
                const modal = document.getElementById('stage-modal');
                const closeBtn = modal.querySelector('.close');

                closeBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                });

                window.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });

                // Event listeners pour les onglets principaux
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-btn') && e.target.closest('.main-tabs')) {
                        const tabName = e.target.dataset.tab;
                        this.switchMainTab(tabName);
                    }
                });

                // Event listeners pour les boutons de validation
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('validate-btn')) {
                        const stageId = parseInt(e.target.dataset.stage);
                        this.toggleStage(stageId);
                    }
                });

                // Event listeners pour l'ouverture des modales
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('stage-card') || e.target.closest('.stage-card')) {
                        const card = e.target.classList.contains('stage-card') ? e.target : e.target.closest('.stage-card');
                        const stageId = parseInt(card.dataset.stage);
                        const stage = this.itineraryData.find(s => s.etape === stageId);
                        if (stage) {
                            this.openModal(stage);
                        }
                    }
                });

                // Event listeners pour la fermeture des modales
                document.querySelector('.close').addEventListener('click', () => {
                    document.getElementById('stage-modal').style.display = 'none';
                });

                window.addEventListener('click', (e) => {
                    if (e.target === document.getElementById('stage-modal')) {
                        document.getElementById('stage-modal').style.display = 'none';
                    }
                });

                // Event listeners pour les onglets de la modale
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-btn') && e.target.closest('.modal-tabs')) {
                        const tabName = e.target.dataset.tab;
                        this.switchModalTab(tabName);
                    }
                });

                // Event listener pour le bouton de validation dans la modal
                document.getElementById('modal-validate-btn').addEventListener('click', () => {
                    if (this.currentStageId && this.canValidateStage(this.currentStageId)) {
                        this.toggleStage(this.currentStageId);
                        this.updateModalValidateButton(this.currentStageId);
                    }
                });

                // Event listeners pour la sauvegarde des temps
                document.getElementById('save-time').addEventListener('click', () => {
                    this.saveStageTime();
                });

                // Event listeners pour les notes
                document.getElementById('stage-notes').addEventListener('input', (e) => {
                    if (this.currentStageId) {
                        this.stageNotes[this.currentStageId] = e.target.value;
                        this.saveProgress();
                    }
                });

                // Event listeners pour la barre d'outils des notes
                document.getElementById('bold-btn').addEventListener('click', () => {
                    this.insertTextFormat('**', '**');
                });

                document.getElementById('italic-btn').addEventListener('click', () => {
                    this.insertTextFormat('_', '_');
                });

                document.getElementById('list-btn').addEventListener('click', () => {
                    this.insertTextFormat('• ', '');
                });

                document.getElementById('template-btn').addEventListener('click', () => {
                    this.insertTemplate();
                });

                // Event listeners pour l'upload de photos
                document.getElementById('upload-photo-btn').addEventListener('click', () => {
                    document.getElementById('photo-input').click();
                });

                document.getElementById('photo-input').addEventListener('change', (e) => {
                    this.handlePhotoUpload(e.target.files);
                });

                // Event listeners pour le lightbox
                document.getElementById('lightbox').addEventListener('click', (e) => {
                    if (e.target.id === 'lightbox' || e.target.classList.contains('close-lightbox')) {
                        document.getElementById('lightbox').classList.remove('active');
                    }
                });

                // Event listeners pour les contrôles de la carte principale
                document.getElementById('toggle-weather').addEventListener('click', () => {
                    this.toggleMainMapWeather();
                });

                document.getElementById('toggle-poi').addEventListener('click', () => {
                    this.toggleMainMapPOI();
                });

                // Navigation entre sections
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        
                        // Retirer la classe active de tous les liens
                        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                        // Ajouter la classe active au lien cliqué
                        link.classList.add('active');
                        
                        // Masquer toutes les sections
                        document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                        
                        // Afficher la section correspondante
                        const sectionId = link.dataset.section + '-section';
                        document.getElementById(sectionId).classList.add('active');
                        
                        // Si on va sur analytics, mettre à jour les métriques
                        if (link.dataset.section === 'analytics') {
                            this.updateAnalytics();
                        }
                    });
                });
            }

            switchMainTab(tabName) {
                // Désactiver tous les onglets
                document.querySelectorAll('.main-tabs .tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // Activer l'onglet sélectionné
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(`${tabName}-content`).classList.add('active');

                // Initialiser la carte si on passe à l'onglet carte
                if (tabName === 'carte') {
                    setTimeout(() => {
                        this.initMainMap();
                    }, 100);
                }
            }

            initMainMap() {
                const mapContainer = document.getElementById('main-map');
                if (!mapContainer) return;

                // Supprimer la carte existante si elle existe
                if (this.mainMap) {
                    this.mainMap.remove();
                }

                // Créer la nouvelle carte
                this.mainMap = L.map('main-map').setView([42.7, 0.5], 8);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(this.mainMap);

                // Ajouter le tracé GR10 complet
                this.addGR10TrailToMainMap();
                
                // Ajouter les points d'intérêt
                this.addPointsOfInterestToMainMap();
                
                // Créer le graphique d'élévation
                this.createElevationChart();
            }

            addGR10TrailToMainMap() {
                const coordinates = this.getGR10Coordinates();
                const trailCoords = coordinates.map(coord => [coord.lat, coord.lng]);
                
                const trailLine = L.polyline(trailCoords, {
                    color: '#ef4444',
                    weight: 4,
                    opacity: 0.8
                }).addTo(this.mainMap);

                // Ajuster la vue pour voir tout le tracé
                this.mainMap.fitBounds(trailLine.getBounds());

                // Ajouter les marqueurs d'étapes
                coordinates.forEach(coord => {
                    const isCompleted = this.completedStages.has(coord.etape);
                    let markerColor = '#6b7280'; // Gris par défaut
                    
                    if (isCompleted) markerColor = '#10b981'; // Vert si complétée

                    const customIcon = L.divIcon({
                        html: `<div style="background-color: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold;">${coord.etape}</div>`,
                        iconSize: [20, 20],
                        className: 'custom-marker'
                    });

                    L.marker([coord.lat, coord.lng], { icon: customIcon })
                        .addTo(this.mainMap)
                        .bindPopup(`<b>Étape ${coord.etape}</b><br>Altitude: ${coord.alt}m<br>Status: ${isCompleted ? 'Complétée' : 'À faire'}`)
                        .on('click', () => {
                            const stage = this.itineraryData.find(s => s.etape === coord.etape);
                            if (stage) {
                                this.openModal(stage);
                            }
                        });
                });
            }

            addPointsOfInterestToMainMap() {
                const pois = this.getPointsOfInterest();
                
                pois.forEach(poi => {
                    const marker = L.marker([poi.lat, poi.lng])
                        .addTo(this.mainMap)
                        .bindPopup(`<b>${poi.name}</b><br>Type: ${poi.type}`);
                });
            }

            createElevationChart() {
                const canvas = document.getElementById('elevation-chart');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                const coordinates = this.getGR10Coordinates();
                
                const labels = coordinates.map(coord => `Étape ${coord.etape}`);
                const elevations = coordinates.map(coord => coord.alt);

                if (this.elevationChart) {
                    this.elevationChart.destroy();
                }

                this.elevationChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Altitude (m)',
                            data: elevations,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Profil altimétrique du GR10'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Altitude (m)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Étapes'
                                }
                            }
                        }
                    }
                });
            }

            toggleMainMapWeather() {
                const weatherInfo = document.getElementById('weather-info');
                const btn = document.getElementById('toggle-weather');
                
                if (weatherInfo.style.display === 'none') {
                    weatherInfo.style.display = 'block';
                    btn.classList.add('active');
                    this.generateWeatherData();
                } else {
                    weatherInfo.style.display = 'none';
                    btn.classList.remove('active');
                }
            }

            toggleMainMapPOI() {
                const btn = document.getElementById('toggle-poi');
                btn.classList.toggle('active');
            }

            generateWeatherData() {
                const weatherGrid = document.getElementById('weather-grid');
                const weatherData = [
                    { day: 'Aujourd\'hui', icon: '☀️', temp: '18°C', desc: 'Ensoleillé' },
                    { day: 'Demain', icon: '⛅', temp: '15°C', desc: 'Partiellement nuageux' },
                    { day: 'Après-demain', icon: '🌧️', temp: '12°C', desc: 'Pluie légère' }
                ];

                weatherGrid.innerHTML = weatherData.map(weather => `
                    <div class="weather-item">
                        <div class="weather-icon">${weather.icon}</div>
                        <div class="weather-temp">${weather.temp}</div>
                        <div class="weather-desc">${weather.desc}</div>
                        <div style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.25rem;">${weather.day}</div>
                    </div>
                `).join('');
            }

            switchModalTab(tabName) {
                // Désactiver tous les onglets de la modal
                document.querySelectorAll('.modal-tabs .tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.modal-body .tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // Activer l'onglet sélectionné
                document.querySelector(`.modal-tabs [data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');

                // Actions spécifiques selon l'onglet
                if (tabName === 'rating') {
                    this.setupRatingEventListeners();
                }
            }

            setStageRating(stageId, rating) {
                this.stageRatings[stageId] = rating;
                this.saveProgress();
                this.highlightStars(rating);
            }

            loadStageRating(stageId) {
                const rating = this.stageRatings[stageId] || 0;
                this.updateStarDisplay(rating);
            }

            updateStarDisplay(rating) {
                document.querySelectorAll('.star').forEach((star, index) => {
                    star.classList.toggle('active', index < rating);
                });
            }

            highlightStars(rating) {
                document.querySelectorAll('.star').forEach((star, index) => {
                    star.classList.toggle('active', index < rating);
                });
            }

            handlePhotoUpload(files) {
                if (!this.currentStageId) return;

                Array.from(files).forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            if (!this.stagePhotos[this.currentStageId]) {
                                this.stagePhotos[this.currentStageId] = [];
                            }
                            
                            const photoData = {
                                id: Date.now() + Math.random(),
                                src: e.target.result,
                                name: file.name
                            };
                            
                            this.stagePhotos[this.currentStageId].push(photoData);
                            this.saveProgress();
                            this.loadStagePhotos(this.currentStageId);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            loadStageTime(stageId) {
                const timeData = this.stageTimes[stageId];
                const hoursInput = document.getElementById('hours-input');
                const minutesInput = document.getElementById('minutes-input');
                const timeDisplay = document.getElementById('time-display');
                
                if (timeData) {
                    hoursInput.value = timeData.hours;
                    minutesInput.value = timeData.minutes;
                    
                    const totalMinutes = timeData.hours * 60 + timeData.minutes;
                    const displayHours = Math.floor(totalMinutes / 60);
                    const displayMinutes = totalMinutes % 60;
                    
                    timeDisplay.innerHTML = `
                        <i class="fas fa-clock"></i>
                        <strong>Temps réalisé :</strong> ${displayHours}h${displayMinutes.toString().padStart(2, '0')}
                        ${totalMinutes > 0 ? `<span style="margin-left: 1rem; color: var(--text-light);">(${totalMinutes} minutes)</span>` : ''}
                    `;
                } else {
                    hoursInput.value = '';
                    minutesInput.value = '';
                    timeDisplay.innerHTML = '<i class="fas fa-info-circle"></i> Aucun temps enregistré pour cette étape.';
                }
            }

            loadStagePhotos(stageId) {
                const gallery = document.getElementById('photos-gallery');
                const photos = this.stagePhotos[stageId] || [];
                
                gallery.innerHTML = photos.map(photo => `
                    <div class="photo-item">
                        <img src="${photo.src}" alt="Photo étape ${stageId}" onclick="dashboard.openLightbox('${photo.src}')">
                        <button class="delete-photo" onclick="dashboard.deletePhoto(${stageId}, '${photo.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }

            deletePhoto(stageId, photoId) {
                if (this.stagePhotos[stageId]) {
                    this.stagePhotos[stageId] = this.stagePhotos[stageId].filter(photo => photo.id != photoId);
                    this.saveProgress();
                    this.loadStagePhotos(stageId);
                }
            }

            openLightbox(imageSrc) {
                const lightbox = document.getElementById('lightbox');
                const lightboxImg = document.getElementById('lightbox-img');
                lightboxImg.src = imageSrc;
                lightbox.classList.add('active');
            }

            initStageMap(stageId) {
                // Initialiser la carte seulement quand l'onglet carte est cliqué
                const mapTab = document.querySelector('[data-tab="map"]');
                if (mapTab) {
                    mapTab.addEventListener('click', () => {
                        setTimeout(() => {
                            this.createStageMap(stageId);
                        }, 150);
                    });
                }
            }

            createStageMap(stageId) {
                const mapContainer = document.getElementById('stage-map');
                if (!mapContainer) return;

                // Détruire la carte existante si elle existe
                if (this.stageMap) {
                    this.stageMap.remove();
                    this.stageMap = null;
                }

                const coordinates = this.getGR10Coordinates();
                const stageCoord = coordinates.find(coord => coord.etape === stageId);
                
                if (!stageCoord) {
                    mapContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-light);">Coordonnées non disponibles pour cette étape</div>';
                    return;
                }

                // Vider le container
                mapContainer.innerHTML = '';

                // Créer la carte centrée sur l'étape
                this.stageMap = L.map('stage-map').setView([stageCoord.lat, stageCoord.lng], 10);

                // Ajouter les tuiles OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(this.stageMap);

                // Forcer le redimensionnement de la carte
                setTimeout(() => {
                    this.stageMap.invalidateSize();
                }, 100);

                // Ajouter le tracé du GR10 complet
                this.addGR10Trail(stageId);

                // Ajouter les points d'intérêt
                this.addPointsOfInterest();
            }

            addGR10Trail(currentStage) {
                const coordinates = this.getGR10Coordinates();
                const trailCoords = coordinates.map(coord => [coord.lat, coord.lng]);
                
                // Tracé complet du GR10
                const trailLine = L.polyline(trailCoords, {
                    color: '#ef4444',
                    weight: 4,
                    opacity: 0.8
                }).addTo(this.stageMap);

                // Ajouter tous les marqueurs d'étapes
                coordinates.forEach(coord => {
                    const isCompleted = this.completedStages.has(coord.etape);
                    const isCurrent = coord.etape === currentStage;
                    
                    let markerColor = '#6b7280'; // Gris par défaut
                    if (isCurrent) markerColor = '#2563eb'; // Bleu pour l'étape actuelle
                    else if (isCompleted) markerColor = '#10b981'; // Vert pour complétées
                    
                    const customIcon = L.divIcon({
                        html: `<div style="background-color: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold;">${coord.etape}</div>`,
                        iconSize: [20, 20],
                        className: 'custom-marker'
                    });

                    L.marker([coord.lat, coord.lng], { icon: customIcon })
                        .addTo(this.stageMap)
                        .bindPopup(`<b>Étape ${coord.etape}</b><br>Altitude: ${coord.alt}m<br>Status: ${isCompleted ? 'Complétée' : 'À faire'}`)
                        .on('click', () => {
                            if (coord.etape !== currentStage) {
                                // Fermer la modal actuelle et ouvrir celle de l'étape cliquée
                                const stage = this.itineraryData.find(s => s.etape === coord.etape);
                                if (stage) {
                                    document.getElementById('stage-modal').style.display = 'none';
                                    setTimeout(() => this.openModal(stage), 100);
                                }
                            }
                        });
                });
            }

            addPointsOfInterest() {
                const pois = this.getPointsOfInterest();
                
                pois.forEach(poi => {
                    const poiIcon = L.divIcon({
                        html: `<div style="font-size: 16px;">${poi.icon}</div>`,
                        iconSize: [20, 20],
                        className: 'poi-marker'
                    });

                    L.marker([poi.lat, poi.lng], { icon: poiIcon })
                        .addTo(this.stageMap)
                        .bindPopup(`<b>${poi.name}</b><br>Type: ${poi.type}`);
                });
            }

            toggleElevationChart() {
                const chartDiv = document.getElementById('elevation-chart');
                const btn = document.getElementById('show-elevation-btn');
                
                if (chartDiv.style.display === 'none') {
                    chartDiv.style.display = 'block';
                    btn.classList.add('active');
                    this.createElevationChart();
                } else {
                    chartDiv.style.display = 'none';
                    btn.classList.remove('active');
                }
            }

            createElevationChart() {
                const canvas = document.getElementById('elevation-canvas');
                const ctx = canvas.getContext('2d');
                
                if (this.elevationChart) {
                    this.elevationChart.destroy();
                }

                const coordinates = this.getGR10Coordinates();
                const labels = coordinates.map(coord => `Étape ${coord.etape}`);
                const elevations = coordinates.map(coord => coord.alt);

                this.elevationChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Altitude (m)',
                            data: elevations,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Profil altimétrique du GR10'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Altitude (m)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Étapes'
                                }
                            }
                        }
                    }
                });
            }

            toggleWeatherInfo() {
                const weatherDiv = document.getElementById('weather-info');
                const btn = document.getElementById('show-weather-btn');
                
                if (weatherDiv.style.display === 'none') {
                    weatherDiv.style.display = 'block';
                    btn.classList.add('active');
                    this.loadWeatherData();
                } else {
                    weatherDiv.style.display = 'none';
                    btn.classList.remove('active');
                }
            }

            loadWeatherData() {
                // Simulation de données météo (en réalité, on utiliserait une API comme OpenWeatherMap)
                const weatherGrid = document.getElementById('weather-grid');
                const mockWeatherData = [
                    { day: 'Aujourd\'hui', icon: '☀️', temp: '18°C', desc: 'Ensoleillé' },
                    { day: 'Demain', icon: '⛅', temp: '15°C', desc: 'Partiellement nuageux' },
                    { day: 'Après-demain', icon: '🌧️', temp: '12°C', desc: 'Pluie légère' },
                    { day: 'J+3', icon: '🌤️', temp: '16°C', desc: 'Éclaircies' }
                ];

                weatherGrid.innerHTML = mockWeatherData.map(weather => `
                    <div class="weather-item">
                        <div class="weather-icon">${weather.icon}</div>
                        <div class="weather-temp">${weather.temp}</div>
                        <div class="weather-desc">${weather.desc}</div>
                        <div style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--text-light);">${weather.day}</div>
                    </div>
                `).join('');
            }

            togglePointsOfInterest() {
                const btn = document.getElementById('show-poi-btn');
                btn.classList.toggle('active');
                
                if (this.stageMap) {
                    // Ici on pourrait masquer/afficher les POI sur la carte
                    // Pour la démo, on recharge simplement les POI
                    this.addPointsOfInterest();
                }
            }

            // Nouvelles méthodes pour les ratings détaillés
            updateCategoryRating(container, rating) {
                const stars = container.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
            }

            highlightCategoryStars(container, rating) {
                const stars = container.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
            }

            loadCategoryRating(container, category) {
                let rating = 0;
                if (category === 'overall') {
                    rating = this.stageRatings[this.currentStageId] || 0;
                } else {
                    rating = this.detailedRatings[this.currentStageId]?.[category] || 0;
                }
                this.updateCategoryRating(container, rating);
                this.updateRatingLabel(container, rating, category);
            }

            loadDetailedRatings(stageId) {
                const categories = ['difficulty', 'scenery', 'trail', 'accommodation', 'overall'];
                categories.forEach(category => {
                    const container = document.querySelector(`[data-category="${category}"]`);
                    if (container) {
                        this.loadCategoryRating(container, category);
                    }
                });
            }

            updateRatingLabel(container, rating, category) {
                const label = container.parentElement.querySelector('.rating-label');
                if (!label) return;

                const labels = {
                    difficulty: ['Très facile', 'Facile', 'Modéré', 'Difficile', 'Très difficile'],
                    scenery: ['Décevant', 'Correct', 'Joli', 'Magnifique', 'Exceptionnel'],
                    trail: ['Très mauvais', 'Mauvais', 'Correct', 'Bon', 'Excellent'],
                    accommodation: ['Très mauvais', 'Mauvais', 'Correct', 'Bon', 'Excellent'],
                    overall: ['Décevant', 'Correct', 'Bien', 'Très bien', 'Exceptionnel']
                };

                if (rating > 0 && labels[category]) {
                    label.textContent = labels[category][rating - 1];
                } else {
                    label.textContent = '';
                }
            }

            // Méthodes pour la barre d'outils des notes
            insertTextFormat(before, after) {
                const textarea = document.getElementById('stage-notes');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const selectedText = textarea.value.substring(start, end);
                
                const newText = before + selectedText + after;
                textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
                
                // Repositionner le curseur
                const newCursorPos = start + before.length + selectedText.length + after.length;
                textarea.setSelectionRange(newCursorPos, newCursorPos);
                textarea.focus();
            }

            insertTemplate() {
                const template = `🌤️ MÉTÉO :
• Conditions : 
• Température : 
• Vent : 

🥾 SENTIER :
• État : 
• Balisage : 
• Difficultés particulières : 

📍 POINTS D'INTÉRÊT :
• 
• 

🏠 HÉBERGEMENT :
• Qualité : 
• Accueil : 
• Conseils : 

💡 CONSEILS :
• 
• `;

                const textarea = document.getElementById('stage-notes');
                const currentValue = textarea.value;
                textarea.value = currentValue + (currentValue ? '\n\n' : '') + template;
                textarea.focus();
            }

            setupRatingEventListeners() {
                // Supprimer les anciens event listeners pour éviter les doublons
                document.querySelectorAll('.star-rating').forEach(ratingContainer => {
                    const newContainer = ratingContainer.cloneNode(true);
                    ratingContainer.parentNode.replaceChild(newContainer, ratingContainer);
                });

                // Ajouter les nouveaux event listeners
                document.querySelectorAll('.star-rating').forEach(ratingContainer => {
                    const category = ratingContainer.dataset.category;
                    const stars = ratingContainer.querySelectorAll('.star');
                    
                    stars.forEach(star => {
                        star.addEventListener('click', (e) => {
                            const rating = parseInt(e.target.dataset.rating);
                            
                            if (category === 'overall') {
                                this.stageRatings[this.currentStageId] = rating;
                            } else {
                                if (!this.detailedRatings[this.currentStageId]) {
                                    this.detailedRatings[this.currentStageId] = {};
                                }
                                this.detailedRatings[this.currentStageId][category] = rating;
                            }
                            
                            this.updateCategoryRating(ratingContainer, rating);
                            this.updateRatingLabel(ratingContainer, rating, category);
                            this.saveProgress();
                        });

                        star.addEventListener('mouseover', (e) => {
                            const rating = parseInt(e.target.dataset.rating);
                            this.highlightCategoryStars(ratingContainer, rating);
                        });
                    });

                    ratingContainer.addEventListener('mouseleave', () => {
                        this.loadCategoryRating(ratingContainer, category);
                    });
                });
            }

            saveStageTime() {
                if (!this.currentStageId) return;
                
                const hours = parseInt(document.getElementById('hours-input').value) || 0;
                const minutes = parseInt(document.getElementById('minutes-input').value) || 0;
                
                this.stageTimes[this.currentStageId] = { hours, minutes };
                this.saveProgress();
                this.loadStageTime(this.currentStageId);
            }

            updateModalValidateButton(stageId) {
                const btn = document.getElementById('modal-validate-btn');
                const isCompleted = this.completedStages.has(stageId);
                const canValidate = this.canValidateStage(stageId);
                
                // Reset classes
                btn.className = 'modal-validate-btn';
                
                if (isCompleted) {
                    btn.classList.add('completed');
                    btn.innerHTML = '<i class="fas fa-check"></i><span>Complétée</span>';
                } else if (canValidate) {
                    btn.innerHTML = '<i class="fas fa-plus"></i><span>Valider</span>';
                } else {
                    btn.classList.add('disabled');
                    btn.innerHTML = '<i class="fas fa-lock"></i><span>Verrouillée</span>';
                    btn.disabled = true;
                }
                
                if (canValidate || isCompleted) {
                    btn.disabled = false;
                }
            }
        }

        // Initialiser l'application
        document.addEventListener('DOMContentLoaded', () => {
            // Initialiser le dashboard
            const dashboard = new GR10Dashboard();
            
            // Rendre la fonction deletePhoto accessible globalement
            window.dashboard = dashboard;
        });
    </script>
</body>
</html>
